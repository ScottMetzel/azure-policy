{
    "properties": {
        "displayName": "Configure Log Analytics extension on Azure Arc enabled Windows servers with multiple connections",
        "policyType": "Custom",
        "mode": "Indexed",
        "description": "Enable VM insights on servers and machines connected to Azure through Arc enabled servers by installing the Log Analytics virtual machine extension. VM insights uses the Log Analytics agent to collect the guest OS performance data, and provides insights into their performance. See more - https://aka.ms/vminsightsdocs.",
        "metadata": {
            "version": "2.0.1",
            "category": "Monitoring"
        },
        "parameters": {
            "logAnalytics": {
                "type": "String",
                "metadata": {
                    "displayName": "Log Analytics workspace",
                    "description": "Specify the Log Analytics workspace the agent should be connected to. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                    "strongType": "omsWorkspace",
                    "assignPermissions": true
                }
            },
            "stopOnMultipleConnections": {
                "type": "Boolean",
                "defaultValue": true,
                "allowedValues": [
                    true,
                    false
                ],
                "metadata": {
                    "displayName": "Stop On Multiple Connections",
                    "description": "Controls whether the Log Analytics agent Extension should fail provisioning if multiple connections are detected."
                }
            },
            "effect": {
                "type": "string",
                "defaultValue": "DeployIfNotExists",
                "allowedValues": [
                    "DeployIfNotExists",
                    "Disabled"
                ],
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [{
                        "field": "type",
                        "equals": "Microsoft.HybridCompute/machines"
                    },
                    {
                        "field": "Microsoft.HybridCompute/machines/osName",
                        "equals": "windows"
                    }
                ]
            },
            "then": {
                "effect": "[parameters('effect')]",
                "details": {
                    "type": "Microsoft.HybridCompute/machines/extensions",
                    "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
                    ],
                    "existenceCondition": {
                        "allOf": [{
                                "field": "Microsoft.HybridCompute/machines/extensions/type",
                                "equals": "MicrosoftMonitoringAgent"
                            },
                            {
                                "field": "Microsoft.HybridCompute/machines/extensions/publisher",
                                "equals": "Microsoft.EnterpriseCloud.Monitoring"
                            },
                            {
                                "field": "Microsoft.HybridCompute/machines/extensions/provisioningState",
                                "equals": "Succeeded"
                            }
                        ]
                    },
                    "deployment": {
                        "properties": {
                            "mode": "incremental",
                            "template": {
                                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                "contentVersion": "1.0.0.0",
                                "parameters": {
                                    "vmName": {
                                        "type": "string"
                                    },
                                    "location": {
                                        "type": "string"
                                    },
                                    "logAnalytics": {
                                        "type": "string"
                                    },
                                    "stopOnMultipleConnections": {
                                        "type": "bool",
                                        "defaultValue": true,
                                        "metadata": {
                                            "description": "Controls whether the Log Analytics agent Extension should fail provisioning if multiple connections are detected."
                                        }
                                    }
                                },
                                "variables": {
                                    "vmExtensionName": "MicrosoftMonitoringAgent",
                                    "vmExtensionPublisher": "Microsoft.EnterpriseCloud.Monitoring",
                                    "vmExtensionType": "MicrosoftMonitoringAgent"
                                },
                                "resources": [{
                                    "name": "[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                                    "type": "Microsoft.HybridCompute/machines/extensions",
                                    "location": "[parameters('location')]",
                                    "apiVersion": "2019-12-12",
                                    "properties": {
                                        "publisher": "[variables('vmExtensionPublisher')]",
                                        "type": "[variables('vmExtensionType')]",
                                        "settings": {
                                            "workspaceId": "[reference(parameters('logAnalytics'), '2015-03-20').customerId]",
                                            "stopOnMultipleConnections": "[parameters('stopOnMultipleConnections')]"
                                        },
                                        "protectedSettings": {
                                            "workspaceKey": "[listKeys(parameters('logAnalytics'), '2015-03-20').primarySharedKey]"
                                        }
                                    }
                                }],
                                "outputs": {
                                    "policy": {
                                        "type": "string",
                                        "value": "[concat('Enabled extension for VM', ': ', parameters('vmName'))]"
                                    }
                                }
                            },
                            "parameters": {
                                "vmName": {
                                    "value": "[field('name')]"
                                },
                                "location": {
                                    "value": "[field('location')]"
                                },
                                "logAnalytics": {
                                    "value": "[parameters('logAnalytics')]"
                                },
                                "stopOnMultipleConnections": {
                                    "value": "[parameters('stopOnMultipleConnections')]"
                                }
                            }
                        }
                    }
                }
            }
        }
    },
    "id": "/providers/Microsoft.Authorization/policyDefinitions/69af7d4a-7b18-4044-93a9-2651498ef203",
    "name": "69af7d4a-7b18-4044-93a9-2651498ef203"
}